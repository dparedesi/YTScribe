---
video_id: iXor74El2D8
video_url: https://www.youtube.com/watch?v=iXor74El2D8
is_generated: False
is_translatable: True
---

Hi everybody, um, happy Thursday, unofficial last day of reinvent. How y'all doing? OK, alright, that's the energy. OK, I was actually watching some of the talks that like my coworkers presented on like Monday morning at 8 o'clock and there's nothing, there was silence, um, that was so devastating for me to watch. This will not be like that. We are friends up here and we're gonna go on a journey today through infrastructure's code and governance and it's gonna be very fun. Um, but before we get into all of that, I do have some questions for you all because this is an us situation. This is not a breakout session. They won't let me do those anymore. Um, this is a us session, so like if you have any questions at any time, you just say David Sefi, and we'll be like, what's up? Um, speaking of David, I'm David. Uh, my name is David Kilman. I'm a principal engineer in AWS, specifically infrastructures code, so things like. Um, cloud formation and terraform and CDK, a quick survey, who here uses infrastructure as code? Oh, that is a beautiful 100% um, maybe I, we actually can't see up here because of the light, so I, I will, the narrative will be changed to suit the talk, um, uh, a quick survey who uses cloud formation? OK, I see you, I see you. Uh, who's this terraform? Nice. Who uses both? Oh yeah, I like this guy. Um, cool. Oh, any Plumi? Any, any Plumi people? They have the best swag at the, that's why I ask. OK, anyway, um, so my name is David Kilman. I am a senior, uh, principal engineer on cloud formation, and today we're talking about, um, infrastructures code governance, making deployments of IAC safe, um, and, uh, I am joined today byefi. This is my friend. Hi, nice to meet you all. I'm Sefi Abrech. I'm a senior solution architect. I'm working with governance and compliance and security. This is the side that I'm covering here, and let's get started. OK, so we're all familiar with this uh uh pattern. You write in some code, write some cloud formation, some terraform, you push it to your gate, and then there is the CICD pipeline that start running, right? And you have your resources deployed inside your AWS account. We're all familiar with it, right? This is how we work. Great. But uh How do we implement some gutters around this situation? And this is what we're going to talk about today. We will run this slide, so we go to the codes directly. Um, so developers are moving very fast, right? You all use, I believe, generative AI to generate code to help you with the infrastructure. And we need something to help you stay in the guards of your organization, the security requirements, cost requirements, even machines image requirements. So let's see if the car is working. This took us like a few hours to put together. It's working. Inside the garble. Yeah, please hold the applause until the end. So, what we're going this is the one in cloud formation hooks is coming to help us, huh? 00 dude. It's so good we want to show you twice. You make it so good. Ah, yeah, see what automation don't do cops do. So on the left side, on the right side, you see the simple cloud formation template to going to create a resource. And it's going to be failed, OK, it's going to be failed because it's not, uh, a stand in the organizational requirements, OK. And now I'm passing to David. Well, give you some use cases. Cool. So whenever we talk about failing things, Sefi always, uh, sends it back to me, um, so, uh, yeah, today we're gonna talk about infrastructure as code and like how proactive controls can stop bad things from happening. Um, so we're gonna talk about hooks. Uh, hooks, hooks is a cloud formation feature. Um, I work on cloud formation. They sign all of my paychecks, um, but we also realized that like infrastructure's code spans beyond just cloud formation. So we're also gonna talk about terraform, um, in a bit. So, uh, for the first part of this talk we're gonna do a lot of demos in cloud formation, but Steffi's gonna show you how things work in terraform as well. I just, um, I, anytime I type. For terraform apply on my Amazon issued laptop. It like lights on fire. So, um, Sefi will be doing the terraform stuff, but, uh, the, the root of it is like proactive controls are the same across all of IAC, right? And like what are proactive controls for, um, you know, I think probably the most common and like most important reason we talk about proactive controls is around things like safety and governance, um. And we wanna stop bad things from happening basically, right? So if you look at this slide, it's like a really simple slide, right? Um, I have a, this is on the left is a cloud formation template and this is the simplest cloud formation template I could write. It just creates an S3 bucket, um. And on the right you can see that like if I tried to provision this bucket it actually fails because uh there's no bucket encryption enabled and that's totally fine right like I think uh quick question for the audience like who who here considers themselves like security people like security is part of my responsibility cool um who how about platforming people like the platform team? OK cool yeah so right like we see this a lot like I'm an engineer and I don't know if you can. Intel like I kind of just do stuff very fast. I basically try to find the fastest way to make things work, um, and I don't always think about the platform. Um, I always think about security, but sometimes I omit security in the name of speed, uh, like this bucket, uh, I think like all of us in like security and like platforming teams are familiar with like this trade off, right? Like developers wanna go really fast but like we who own the platform or get paid for security incidents. Don't wanna sacrifice like the platform security or like governance or like compliance, you know, we tons of organizations have things like FedRAM compliance or like NIS compliance, all these like compliance packs which require you to be like always put on bucket encryption or like enable object lock on your S Suite bucket, right? Like these are kind of like really nuanced like configuration options that we don't really wanna have to have that conversation with developers every time they wanna create an S Suite bucket that um. They have to turn on SSE encryption for their bucket, right? We wanna make sure that they can move fast but like not break our platform. So hooks and like proactive controls help stop bad things from happening before they happen. Um, I, I'm gonna tell you a story. We're gonna have a lot of stories and they're all gonna be a little embarrassing about me, um, or our interns, uh, but, uh, a long time ago, does anyone remember, um, when Lambda launched Function Endpoints, uh, a long time, it, it was like maybe 2 or 3 years ago, uh. Um, does anyone here not know what lambda is? It's totally fine. Do we count our lambda? OK, cool. Uh, I love lambda. Um, any time reinvent is very fun for us as well because this is the first time we're hearing a lot about a lot of new features. Um, so I remember a few years ago at Reinvent Lambda launched this feature called Function Endpoints. It basically lets you like generate an HTP URL that when someone calls it, like sends a get request to it or a post request or something, it invokes a lambda function, and I thought this was super cool and it was like really easy to set up, um. And this was sort of back before things like hooks existed, uh, and so I was, uh, I was experimenting. I was writing, I was trying to like set up this like lambda, uh, with the function endpoint, and it was actually really fun. I had it like the lambda function send a like a text message to my manager saying that you should give David a raise, um, and then I posted the URL into like our, our organizations Slack channel and everyone kept cooking. It was, it was really a beautiful day, um, but it was really fun for me because I got. Like, experiment with this new feature. I had a lot of fun with it. Um, the cool thing about function endpoints is that there's also a lot of configuration that you can do for security. You can say, hey, like only like this IP address range can call this endpoint or like it has to be within this like VPC and it's private. Um, those are really cool and I did not care about them, uh, because like I just wanted to get it to work. I wanted to make a funny like joke for my coworkers and send like this link out, um, so I did that. And it was fun and then I was going home. I was going home, uh, and I was on the train like listening to, I don't know, some podcast or something and like I got this like, like my, I thought, I thought it was like an amber alert, but I was actually getting paged and I was like this is what I'm not, I am not on call. Why am I getting paged and it turns out like our we had this reactor, uh, detective control system that like scanned our AWS accounts every hour or so to make sure that like all of our. Resources were compliant and it turns out like our security team um had decided that like a globally accessible function endpoint that costs money when it is invoked that's just accessible by anyone was not compliant with security um so I, I had to like get off the train and like go find a coffee shop and like go like read this ticket that I got paid for and like go disable this uh delete this function. Um, I was really mad actually. This is the thing that radicalized me on proactive controls. This is why I care about it so much because I was like, how did you just let me create something that you knew was wrong, right? So that's where proactive controls comes in like that experience for developers, it kind of sucks, right? Like you page, like if you create a resource and it is misconfigured and you just let it happen like that. Change can propagate through pipelines. It can go to production, and reactive controls and detective controls are amazing. They're like, uh, they're a like they always catch things, but proactive controls are better because they can stop things before they happen. Um, so that's why I love, um, uh, proactive controls, and, uh, that was just a long story to say that proactive controls are really good for governance, um. Another thing that proactive controls are really helpful for are stopping you from making accidental mistakes, um. This, so in this example I have, um, uh, a, uh, cloud formation template with an auto scaling group, uh, and my auto scaling group had a minimum of 1 EC2 instance and a maximum of 100 EC2 instances, um, so in, in cloud formation you can create this thing called a change set which is very similar to a terraform plan which basically just says hey I'm transitioning from like this state to this other state, um. So, uh, in this case I had a hook that was running that when I tried to make this change, uh, failed. It failed because the hook had logic in it that said, hey, whenever some sort of like capacity change happens on a bunch of resources so like CPU, memory, I ops, um, like auto scaling group sizes, whenever those changes happen and they exceed 50%, I'm just gonna fail, right, because this is product. Like you're changing things really drastically, uh, so in this example it actually wasn't me. I didn't make the change. I'm not the villain of this particular story. We had an intern. This intern was so smart and much smarter than me, um, and one of the things that our intern was doing was he, they really wanted to like deploy our service to their own like we give all developers at Amazon, they get an AWS account that they can do anything with, um, so. Wanted to deploy our service to their um their own personal account and I was so excited because I was like yay bias for action this is fun you're gonna experiment um and this intern also was like very frugal they're like I don't need 100 EC2 instances being spun up in my account so they actually changed, they changed their template, um, to make it so that like the number of auto scaling, um, the EC2 instances that could be provisioned was 10 instead of 100. Um, and through a series of, uh, unfortunate accidents they accidentally committed this change to our repository and our pipeline picked it up and our pipeline started to try to deploy it to our beta stage and then that's when this hook was invoked and stopped that change from rolling out, which is great because if our service, um, you know, cloud formation powers like 100s of thousands of deployments, um, so if we had only 10 EC2 instances to do that, that would have been a very difficult day for our on call, um. The other nice thing about, um, uh, the thing I like about this story is that, uh, Amazon has like this culture called like COE culture. Are folks familiar with COEs? Um, they're just, uh, yeah, they're just basically like when something goes wrong, you're right, this doc that's like what went wrong? Why did it go wrong, and like most importantly, how do we stop it from happening again. And the reason we had this hook written for our team was not because I'm really wise and a wonderful platform engineer, um, and uh foresaw this is because we had a COE like a couple of years ago where another intern had done something very similar. So the nice thing about like our like COE process is we have these tenants that are actually. Items should not be best intentions, right? So an easy action item is like update a run book and that way when our intern comes back they'll follow the steps to make sure that they do the right thing. We call those like good intentions and like sometimes they're fine but we always are searching for mechanisms like how can we enforce that this bad thing does not happen again. Um, so with things like hooks you can take your learnings from different types of outages like over eager interns or maybe like careless engineers and codify them and enforce them in your IAC that way these mistakes don't have to happen again. Um, OK, I'm gonna go over one more use case that my manager insisted I put in as a punishment. Um, so the other great thing that like proactive controls can do is make sure that you don't spend too much money. Um, sometimes engineers provision extremely large EC2 instances because they're not responsible for their AWS bill, um, and they just leave them in their account and run up huge bills. Um, that is. Something I have done, so now we have a, a hook on our team only that makes sure that like there's a set of allow listed, uh, EC2 instances that we can deploy. Um, that's my manager made me do that, um, because we had a huge bill, but our actual practical reason why folks would do this a lot is, you know, uh, a lot of organizations do a lot of negotiation with Amazon to make sure that we have like savings plans or like certain EC2. Instances that we get discounts on and that's really hard information to like trickle down to engineers or people who are building platforms know that like hey you should only use this particular type of instance because we get a discount on it um so that kind of information can be codified in like a proactive control that says hey like you didn't do anything wrong it's just that you tried to like there's a better um instance type that you can use uh that we get a discount on. So part of controls can help you with things like governance and security. They can help codify best practices and learnings from COEs. They can help you, uh, make sure that like trickle down, uh, uh, organizational best practices like, uh, cost, uh, best practices, um, so they're really. Useful and they're kind of like uh I think they uh in in the IAC world they're super valuable and I think in cloud formation and Amazon specifically like we're only just in the past couple of years really like understanding how valuable these are um so I'm excited for us to like get together and experiment with them. Cool, uh, so you thought that it was cool that I was talking for so long, uh, but now we're actually gonna code because this is a code talk, um, so in this code talk we're gonna do a couple of things. Uh, I'm gonna teach you a little bit about cloud formation guard. This is our, our, um. Policy is code DSL, um, there's nothing really special about guard here. Like you can replace it in your mind with, uh, any policy has code language that you're familiar with like Sentinel or Rego or like check off, whatever you're comfortable with like conceptually they all do the same thing. Um, I'm gonna show you how to build a hook using guard. Uh, we're going to go through a beautiful journey of trying to deploy a cloud formation stack, a process that I'm sure we've all experienced and enjoyed a lot, um, and then I'm gonna show you how we cannot do any of that and just use a couple of clicks to, um, build a hook using something called the control catalog. Um, and of course, uh, I will, we have, we're going to show you how to make it work in terraform too, which is gonna be fun and delightful, um, but now we're actually gonna do all that stuff, cool, so, yeah, switch. OK, I'm gonna assume my official coding position which is sitting on this chair with my knees, um, cool, uh, yeah, let's get into it. Let's build stuff. OK, so also this Amazon has this thing called connections where every day they ask us a question and you cannot stop it from happening and it always pops up during presentations so I'm gonna move this over here and we're just not gonna talk about it anymore. OK, cool, so let's set up some proactive controls for IAC and show how they work. All right, so let's go to cloud formation. Which is my favorite, uh, IAC service that's natively hosted on AWS. I talk a lot of smack about Terraform, but I actually love it, so please don't take it personally. Um, I'm gonna, uh, close every single notification that came up because we are very eager this year to open, uh, launch a lot of features. And I'm gonna go to our hook section. So, um, this, this is our hooks page. Uh, this is a, um, like 3 step picture that explains in, uh, what I took 20 minutes to explain. So this is always delightful if you ever forget and don't feel like listening to this talk again. Um, it just shows how, uh, like a hook basically sits in front of cloud formation doing something and evaluates if that thing is good or bad. If it is bad, it stops that bad thing from happening, um. So I'm gonna actually go down here and we're gonna create a hook and we're gonna use guard because that's my DSL of choice and OK so over here it tells us like hey you have to upload your guard rules to S3. Um, and so this is a code talk, so I'm supposed to be coding, but I'm remarkably lazy, so we're not actually gonna write these rules ourselves, um, so there's this community on, on GitHub, uh, of pre-written guard rules, uh, which are super cool. So I'm actually just gonna go steal this from our guard rules registry. So this is GitHub. Uh, if we go into the rules, you can see that there's a bunch of different AWS services, so like Amazon S3, this is one of my favorite ones, so I'm gonna click it and you can see that there's a bunch of different, uh, uh, files that map to a policy. So we have S3 bucket default block enabled, um, S3 bucket logging is enabled, uh, there, there's a bunch of, well, let's see what is a good one? Oh, bucket versioning enabled, that's kind of fun. So, um, we're gonna just, I, I already took a few of these, but I just wanted to show you, um, there's a bunch of different services over here. Uh, let's see, IAM exists, which is always a fun one, and IM has a bunch of like IM is probably the, the place where. You can do the most damage from a security point of view, um, so there's a lot of really fun like, uh, oh, policies written already for IM, for example, no admin access, uh, which is, um, delightful we should not have admin access for a lot of. Things, um, so you know, I, what I did, uh, earlier for demo magic purposes is I cloned, uh, this repository locally and I took a couple of rules, um, from that repository, so I have some Dynamo DB, some IM, some lambda, some S3, and I just zipped it up. And then I uploaded it to S3. Uh, we never know what the Wi Fi situation is gonna be in these rooms, so I try to like pre-buffer as much as, as much as I can. So, um, I'm gonna go. I, I uploaded my guard rules to S3 earlier, so I'm gonna select this. And I'm gonna tell guard to write a bunch of logs whenever something fails, and we're gonna call this something, um, this is fun. Does anyone have a fun name for this hook that we should call it? I'm thinking very good hook. Does anyone have any other suggestions? What? That, that I don't know that I don't know what I expected from that. Uh, I heard someone say, uh, uh, I don't know, I heard gotcha hook. I like that because it's like pew pew. I got you. Um, so we're gonna call this the gotcha hook, and hooks can run in a lot of different places. So before a cloud formation stack is updated, uh, through cloud control API at change sets, um, for this we're gonna just do resources. We're gonna, so any time cloud formation goes to provision a resource, it's gonna run these guard rules to make sure that resource is compliant. And I'm gonna tell um hooks to run this whenever a resource is updated or created. And there's this thing called a hook mode. So a hook, um, I'm gonna change it to fail. So basically any time this hook evaluates to false, it blocks something. You can also put a hook and warn mode so like a hook can fail and it doesn't actually block something. So this is really good if you're like authoring new rules and you wanna test them out without necessarily blocking people, um, but for this we're gonna block it and I'm gonna create, uh, a new role called the gotcha roll. Um, cool, um, you can tell, uh, you can have hooks be really specific on exactly when they run. I'm just gonna have it run all the time. And I'm gonna create this hook. Yay, cool. OK, so I created this up. It's running in my account now. Um, fun question, uh, has anyone here used Gen AI for IAC stuff yet? OK, cool. Yeah, it's fun. It's fun. I also use Gen AI for IAC stuff, uh, for this talk. I, uh, asked Kiro to generate for me a, um, a, a template, a cloud formation template. And I asked my prompt to Kira was basically like I want a really simple cloud formation template that creates a lambda function, um, a Dynamo DB table, and an S3 bucket, um, just to create a really simple application that writes to Dynamo DB and pulls files from S3. And this is the this is the template that it gave me, um, it created a lambda execution role. um, this is the role that lambda will use to do stuff um it created a lambda function, um, so a simple inline function using no JS sure, I don't, that sounds good, um, it created an S3 bucket with no properties fine, that is a correct bucket. And I created a Dynamo DB table and the thing that I like about um this like template that it generated is it tried a little hard, right? Like it turned on a point in time recovery for me which is a really nice gesture. I do appreciate that because um you don't wanna accidentally delete your Dynamo DV table and realize you don't have a point in time recovery. Turned on, so, um, this, this is a great template, uh, and I think maybe as I was scrolling through this, the security people may have lifted an eyebrow or, or maybe folks realized, um, that I was alluding to certain things earlier with this S3 bucket, but, uh, I'm, we're gonna, we're gonna try to deploy it to cloud formation and see what happens now. So I'm going to go take this template. Uh, cloth from the web, oops, sorry. Cohoon next. Uh Yeah. Oops, sorry. I don't, um, sometimes the, um, uh, the AI doesn't always create perfectly valid cloud formation. OK, so that one works. OK, we're gonna call this, this will probably work. Um, and I'm going to just power through all these prompts and tell it to do stuff and it's gonna start creating stuff. Oh, does anyone have any feedback for cloud formation? Um, we'll get to that later. We love feedback. OK, cool. Uh, so, uh, cloudformation tried to create my stack, my dynamoji B table, and it failed. So if I scroll through like all of like what happened chronologically. Is, uh, it, it started to, it started creating this lambdaro estuary bucket, um, but before it did anything like actually called the like service APIs to create a bucket or create a lambda function, it invoked our gotcha hook, um, and as you can see, um, like the estuary bucket failed to create because the gotcha hook failed. So if I click on this we can see that, oh, this hook failed with the message that the template, um. Uh, you know, we had a rule called S3 bucket lock enabled that failed, a rule called S3 bucket read prohibited that failed. Um, so, and I guess we're gonna have to fix that. So if I go into like the hook, you can see like, all right, here's the details of this particular hook run. Um, I had a bunch of, you know, we had the lambda rules, uh, rules, and the dynamo DB rule and the IM rules. They did not run because this is an S3 bucket, but the S3 ones did. And I'm gonna click this S3 bucket lock enabled uh real quick and um it kind of gives us uh it tells us exactly what went wrong, right? So it says the check was not compliant because the property um of S3 bucket properties object lock is missing and we have this little helpful hint saying hey like the violation is that S3 um bucket object lock was not set and we should set it to true uh to make this check pass. So just to um I'm gonna show you how what this rule looks like let me see. Oh yeah, so here it is, um, so this is a guard rule, um, so this is all comments, but it's just, uh, this is describing what this rule does. So this is my object lock enabled rule, uh, and what this does is it, uh, every time this rule runs it takes, uh, as input the cloud formation resource that's getting provisioned. And we say this rule applies if any resource type is of AWSS3 bucket. And our rule says that you know S3 bucket default lock must be enabled and it says when it has found uh a resource of type S3 bucket. Assert that there is a property called object block enabled and that the property object block enabled equals true, right? And you can see in this like guard rule I have this like free form text here it says like violation hey like if we get here that means that the object lock enabled property did not exist um and it needs to so we can set this feedback. And if the um S3 bucket lock enabled existed but was not true we say hey you have to set this to true and you can see like this is the data that pops up right here so it it's you can be as specific or as like cryptic as you'd like to be with your. Feedback, but this is a really good example that I think this is really good feedback for me, um, because it's really clear what happens. It's looking for this object lock enabled property and it look is looking for it to be true. So let's go back to our template and help Kiro a little bit. So I'm gonna add a property called object lock enabled, and it says it should be true. I don't know what object lock enabled means, but my platform administrator, who was very wise, said that we needed it. So I'll believe them, um. Actually I do know what object locked enabled is, but it is very cool. So like if you, it's, uh, it's really an interesting feature, but, um, critically, um, that I'm putting my platform hat on now, like you can only enable object lock, uh, on S3 buckets when you're creating the bucket. So this is actually a really good rule because you cannot add that feature after the fact. So, um, we're gonna create it, we're gonna try creating the stack again with my new, new and improved template. And we're gonna call it This Will Death Work. Um, you can see that I go through this experience pretty often, um, so I'm gonna, I'm just gonna power through the cloud formation console and we're gonna say submit. And we're gonna see again what's happened. Oh, it failed. OK, uh, this is not too surprising. We knew some things were gonna fail, but I just wanted to see what, what it looked like now. So if we go back to our, our hook, um, you can see now our, our S3 bucket default lock enabled experience worked. Uh, it, it was fixed, um, and it passed, but we still have this other rule that failed called S3 bucket read prohibited, and if I look at this one, it's a little more complicated, so it's saying, um. Uh, like, it was looking for this property called public access block configuration and the properties of this estuary bucket, um, and you know there's, there's a couple of properties it wanted to be set, so like block public ACLs, block public policy, ignore public ACLs, restrict public bucket access. It wanted all of those to be true, so, um, I think. Buckets being public is bad, um, in general, so we were like I think as the platform teams and security folks we are always really excited when folks wanna make sure that their buckets can have absolutely no way of having public access, um, so by setting all of these values, uh, we can, uh, uh, it's true we can make that a reality. So let's go back to our little SU bucket or I have this public. Block public access block configuration. I'm just gonna like say tell that I'm just gonna copy straight from this output. Uh Boop boop boop And I'm gonna say true. Alright, cool, so I did that. That was fun, um, and I'm sure you all were really excited for me to go through the create wizard again, but we know there's more things that failed, right? Like if I go back to our template. You know, the Dynamo DB table failed. The lambda execution role failed. You know, let's see, uh, Dynamo D B Dynamo DB table failed because table must be encrypted. So, um, this is fun, and you know I enjoy coding with you all, but as a developer experience waiting for my stack to create a resource. And then iteratively trying to fix it is not great, right? Like I think this, this, this stack is really fun because it's serverless. It's using Dynamo, it's S3, it's really fast. But if I was using something like ECS, which like when you create an ECS service in cloud formation, it waits for the deployment to actually be done before it like considers the resource successfully created, that can take a while that can. Take a few minutes if you're creating a cloud front distribution like that also can take minutes so your your stack execution time like can take a while and you don't really wanna find out that you're the template that you're building was not compliant only after like uh minutes like 20-30 minutes um we wanna know early as early as possible. So, um, this is fun. Instead of going through, um. And like iterating on this template one by one trying to fix all these errors I'm gonna show you a fun trick. So we're gonna go back to our hook, our gotcha hook, that was a really good name. I don't know who said that, but you should consider yourself really cool, um, so I'm gonna go to our hook, and you can see like for this hook you can see all the different times it ran, um, and like when it ran, so it, you know, it ran for this old stack, ran for this new stack, um, you can also see if it failed or not, you know, oh, they all failed, um, surprise, uh, but I'm gonna have the, I'm gonna change. This hook to actually run not just when we create resources but when we create a change set, um, so are folks here familiar with change sets? Raise your hand if you know what they are. Cool, um, change sets are basically cloud formation's version of like a terraform plan we I'll, I'll show you about that than just describe it. I'll show you how it works, um. So I'm gonna go to cloud formation. I'm gonna upload my template. And Uh, change sets rule. And OK, so instead of clicking submit and having cloud formation go try to provision everything, I'm gonna create a change set, and this change set will show me like, hey, here are all the things that would happen if you tried to apply that. So this change that says, hey, like if you tried to apply this change set, you're gonna create a dynamoDB table, lambda execution rule, lambda function, um, but my lambda, my change set is actually in a failed state because my hook failed, my, um, my gotcha hook failed, right, so. This time what's cool about like this experience is that you get every single one of the thing like the rules that I ran like they run early and you can see all the details of how to fix this stuff um directly. So if I go back to my gotcha hook, you know, I can look at this, this hook rum, and you can see like, well, look, we fixed a bunch of stuff, we fixed the public read prohibited and we fixed the object lock, but now you can see in one place like, hey, like your Dynamo DB table has to have SSE enabled and your IM, uh, uh, I have a role with an admin policy, and the fix for that is remove it, uh, which makes a lot of sense, so. Uh, just for fun, we're going to, I'm going to show you, uh, we're gonna. Through the power of movie magic, I've already fixed all of this actually, and I'll just show you ta da. How it works. Yeah. What happens in the delightful case? I'll show you. Cool. Yeah, so in this case you can see that my change set can actually run. I can execute it. You can see that, um, our hook passed because we, we fixed it and it was truly delightful. Um, so that's kind of like the experience that I have as like a, a team lead of writing, um, um, confirmation guard to make sure things work. I wanna show you one more thing real quick because confirmation guard is really cool, but not everyone wants to do it. Um, we have another hook called the control catalog, and this is meant, um, for like, uh, compliance checks. So if you look, uh, if we look at, uh, this basically has a bunch of like. Rebuilt, um, policies, uh, so I can, oh see, I can just, so instead of having to write the guard myself, Amazon owns and runs these rules so we maintain them, um, I can basically say hey, like this bucket has to have S3 enabled. I'm versioning enabled. Uh, it has to have server side encryption, and Steffi's gonna show you more about this later, but what's really cool about this is that like these policies are also grouped by like their compliance framework, right? So I was talking about NIST earlier so you can see like oh this rule is, um, part like applies to the NIST framework, uh, and you know I'm super excited about security so I could just create this hook with all of these, um. Uh, uh, proactive controls already enabled and I don't have to write a single line of code, right? Like you can take this home, uh, and just enable this hook in one mode with all these controls turned on and see like, oh, what resources are people in my organization creating which are not compliant, um, and also if you, if you walk in in a multi uh accounts environment you can run it on all accounts. How many of you are walking with multi-account environment from secure perspective? How many of you implement control tower? Oh cool. So after I we show some cool stuff, yeah, yeah, uh, so this is delightful that I'll create this hook. It'll be in my account and I can play with it and experiment with it, but in reality, like Steffi's saying, like you really actually wanna make like apply this to OUs and like enforce it, um, so he'll show you how to do that later. Um, also, uh, you know, I love terraform and I've been talking a lot, so I'm actually gonna hand it over to Sefi to show you how this can work, uh, how you can use conservation hooks, uh, to also run policy and practiceive controls for terraform. Yeah, thank you, David. You're welcome. Let's just fix the credentials. What's up? Oh I don't want to run for for. Just seems like what I want. Yes, so yeah, the question is like why not just have hooks always run on change sets, is that right? Basically, yeah, that's a really good question. There is nuance, um, so when we run at the resource level we're literally about to call the APIs so we have every piece of information that we need to call the APIs at the change set time there are dynamic values that we don't necessarily know so you don't always have all the information that you need like that you would need to make a fully deterministic decision. Um, so an example would be like I need the subnet, uh, you're running, um, you're creating a, uh, RDS instance you wanna look at the, uh, subnet IDs and evaluate to make sure that they're, um, correct, um, like allowed, uh, if your cloud formation template references the subnet ID as an output of like the subnet resource, there's no way like you can know that until you create the resource. Um, so basically like the, it's, it's sort of like a filter you have less information at changed that time because um. Properties that are only evaluated after a resource is created are not available yet because you've not created the resource, um, but at resource time you have all the information so usually like for our hooks we generate, uh, we run them on both and we usually write our rules such that like if the value just isn't present because it's like not, uh, because it hasn't been resolved yet we just skip it. So and that's why I. Why Jean said not that certain values cannot be elaborate at this time. Just seems to Yes. Yes. But that's what I'm saying. Oh yeah, I mean that's fair. Uh, I think, um, we just like Chances is like Chances hook launched last year and so like we don't have like a super opinionated approach yet with like the wizard. It's just, but it's like a fair point. Like I think if I were to create a hook, like the defaults would be like resources and change sets, um, the reason why like some. Sometimes we don't make that is because like Steffi will show you that like like we're gonna apply this to terraform now and Terraform doesn't have change sets so like it's a good point, yeah, like I think for most if you're using cloud formation I would almost always just choose all of the things so like resources stack change set so good oh. A Party Ah, OK, so this, the question is like how do, what do I do with exceptions basically? There's a few things you can do with exception, so I, I skipped through the hook creation screen like pretty quickly, but in there you can basically exempt certain stacks, um, you can just say, you know what, this is fine. Uh, the other thing that I didn't show you is that in the guard hook, um, you can provide this thing called like an input parameter which is, um, like, so a common thing that we see is basically like, um, like this stack and this particular bucket are exempt and so what you would do is like you would put that into like a, a file, put it in S3, and then you tell your guard hook to like read that file and then that data becomes like available um as uh. Uh, like context to write your rules. Another thing is if you look at the guard repository, if there are rules that you think are like useful but like developers should be able to override them themselves if they think, if you look at the guard repository, basically like you can, you can include additional metadata in the cloud formation template, uh, at the top being like I acknowledge this but I don't care and like you can write your rules such that like it's like, OK, as long if there's like a suppression rule in the template I'll skip this rule, but it's up to you, but yeah. Good good question. Uh, was there another question over there? Oh cool I had stated that um there's some certain clients. Yes, uh, so terraform plan is like almost exactly equivalent to, uh, chain sets. The weird thing with terraform plans is like we don't actually like that's on the client side, so we have no interception point for that so we can't apply hooks at that level, um, so we can do it with resources in terraform because we have the AWS cloud control provider which basically just takes. Yeah, yeah, and Steffi's gonna show you that right now, so I won't show you. David, you will help me. Yeah, yeah. So, uh, before we start, I will, uh, run tele from apply and we're going to fail, OK, everybody relax. We're going to fail. This is one of the reasons we're doing it. And then we start walking. So I have two rules. If you saw the template of David before of the cloud formation template for the lambda, you use the deprecated runtime. I think not 16 because he will create it for you. So basically I created some guards that check exactly which run time is inside the resource because you don't want to run deprecated run time. And you see that uh as David mentioned, we use resource type AWS lambda function, and then we take the runtime variables, but from where we take it. We take it from the cloud formation template reference. Are you familiar with that? Who is working with the cloud formation? Yeah, so, also in the, in the rules, you can see which variables you can take from it and then just paste it inside the rule. For example, you can see all the version of the lambda. But now that the telephone is running, I want to see, to show you how we're going to use the AWCC to create the hook. OK? So we'll do it really fast. We're going to create a hook with guard. OK, let me browse the file that I zipped before. OK, and I'm going to use the same bucket for the results also. And of course the name, but in the hook target we're going to use the control cloud control APIs, OK, which basically is going to catch the telephone uh applies that we're doing and it is exactly the same thing like cloud formation nos we can, uh, choose what action we want, create, update, etc. and we can choose if we want to warn or fail. OK, so I already created one of the hooks. Now let's see what happened to our telephone. Oh OK, so basically what we did here. Uh, I also use QO to generate it. OK, we're going to use uh to try to create a lambda with run time. Of no DS 18, which is deprecated. And also we're going to try to deploy an F3 with a lot of missing variables like block public access, bucket encryption, etc. Now there is something new. My skin is a little bit big for me. It's OK. You can see like this. You can see that uh uh also in the telephone in the ID you can see the reason of why the hook fail you. OK, for example, in the S3 bucket you can see that it's failed because S3 encryption required S3 no public read in S3 version enabled like David show before in the you can see through the ID, but if I want to see the exact reason all the output of the souk of what happened. So I can just take Yes, Jason. Add a kind of a dash and then it will be to my STD out over here. OK, so if I'm a developer, I can use it for my VS code, and if I'm a click ops guy, I can use it for theUI, right. OK. Uh, what is we want to see? Just to show you from here also. You see, it's exactly the same like the like the cloud formation looks. It's working the same with styrofoam. Right? OK. Basically this is a demo of. Yeah, the, the cool thing, so Sefi used the AWSCC provider which is different from the AWS provider. Um, with the AWSCC provider, um, basically like, uh, it uses cloud control API under the hood, so it takes the resource and it sends it to cloud formation to create it rather than orchestrating API calls directly on the client side like the AWS provider since we can do since like it sends the entire payload to us before it gets created, that's why hooks can run at the same time, um, that's why you can catch it before, yep, exactly. So we want to show now of how to implement it on organization unit, yeah, um, so any, any questions about the terraform implementation. Oh yeah, can you show the provider? What do you mean provider? Um, yeah. Yeah, so the required provider here is Hashi Corp AWSWCC, yeah, instead of AWS. This is a different because as David mentioned we want to uh catch it before it create a release resource so it's not doing telephone uh API calls straight to the AWS account. It's it's sending the payload and then you can block it before it's happened. Yeah, basically all of these hooks is if we start this talk when we talk about it, it's to uh. Stop people to get call after hours because they create something that they didn't supposed to create and they didn't even know that they're supposed to do it that way. Yeah, yeah, yeah, right? Yeah, yeah, yeah. Right, so this is not a drop-in replacement if you have existing terraform and you're using AWS, the AWS provider. Hooks is not very helpful for you going forward. Um, so our relationship with Hashy Corp is, uh, like the Hashy Corp owns this provider, but like it's a partnership with us, um, and one of the main reasons why like we partnered with Hashi to create this is not for hooks at all. That's just like a nice side effect, but mostly around like coverage. So, um, we, we've noticed. Um, and our customers have noticed that like new feature launches and, um, and terraform like can be like they can lag, uh they can get there before AWS support, uh, AWS and confirmation support resources, but we've noticed a lot with like AWS we have like mandates on like launching with resource support immediately, um, that there's like this growing gap of sort of like medium to like lower popular resources and terraform just never getting like support. Um, and so to like help with that we basically said hey like yes use AWS provider for stuff if you want, but also you have access to the cloud formation versions as well so you can mix and match but, uh, and like a side effect of that is that with hooks you can also intercept like governancey stuff with that. But yes, to your point, like there's not a lot of sugar coating on that if you're using the AWS provider. Later today, um, there we can't, um, put hooks in that call path. The only option you have really is sort of like IM and like SCPs to do, uh, gov governancey stuff, but those are RCPs, clarative policies. There's a lot of options that you can do it in the organization level through control tower to block from this thing to happen, uh, but yeah. Cool, cool, uh, one more question, yeah. got Yes, yes, yes, change sets, uh, change sets and hooks and the control hook and lambda and guard hook, all those things are also in GovCloud, uh, the China regions and the secret regions as well, yeah, we're, uh, actually, um, we had a really interesting launching cloud formation this, uh, like last week or this week. I don't know what day it is, um, where, uh, we do early validation, so like basically. We'll check before a cloud formation stack runs to make sure that like the resources that you're trying to create don't already exist or like some properties aren't set correctly um it's sort of like a developer experience thing but it's built on top of hooks so we're we're like considered part of like launch blocking for news for new region build so hooks and like all of these features are there um for all new regions. Would you like to see how to implement the the controls and hooks on organization? Yes. OK. So, uh, we're going to close all of this. Uh, so I have a multi-count strategy, a landing zone, uh, in this, uh, demo environment, of course. And we're going to, uh, get inside to the management account. It's up and we will go to control towers. Everybody familiar with control tower? Yeah, cool. And we will go to controlled catalog. Just have a new face now, which is amazing. And we're going to filter the controls proactive. Behavior, OK. And then we can choose whatever we want. Uh, any specific redshift. Which is stuff. And you can see exactly what framework like David mentioned before, uh, before, and which regions are also uh deployed. If you work in a region that this control is not available, you cannot deploy it, basically. And we're going to do enable control. And here we can uh uh see also the selected control. You can choose multiple controls. You don't have to choose this one, just for this demo, choose one, so it will be faster. And then we have the organization units that we can choose. So let's take sandbox for example. So I can just let me see that we have a count over there for a second. OK. box. So we choose the OU we can target it and we do enable controls. It will take several seconds. Until it will be provisioned, you can see all the controls that I would implemented. OK, we'll give it a second. And the good thing about it that you can from here you can choose from a security perspective if you want a specific framework and then you can enable those controls. You need to do it carefully because you do want that your team will succeed in this stuff and let's see if it's. Yeah, we'll go to the account. Reinvent. The cool thing about like this approach versus the one I showed like I was enabling the hook in like an individual account. He's enabling it for like an entire OU and like there's a like resource policy on that hook that basically means you cannot turn it off unless you are like the in the um uh root account. So, OK, so you can see we have the guard full governance that I built before and now we have also the control tower hook. That managed by control tower. So under this OU I have like 56, 10, 100 accounts. It's will implement to all of these accounts and of course nobody can be deleted and that's where you can secure your environment from a management account. The nice thing about the control catalog through control tower too is that this talk is called from like reactive to proactive. um, the control tower catalog also like it groups things by control objective so like here's the thing like the control objective that I wanna accomplish like no public S3 buckets um through the control catalog like you can enable the proactive version of it but you can also enable the reactive version, the detective version too, so it's like a defense. Depth thing like if someone goes to the console like they're not going to get or using the AWS provider in terraform they're not going to hit hooks so you still probably want detective controls as well. Basically you want to implement all the kinds of controls. It depends on the environment and the security requirements, but what I do want to show you here is that you have common controls from control tower, of course. It's also divide by services. That means if you're using and stuff like this frameworks. And uh uh and you can see also uh which controllers are enabled and this is also something cool to see exactly uh on which accounts it's enabled if you want to uh I don't know invested how to say uh like look yeah yeah if you wanna look at like the impact that this is having on like different accounts that you have which accounts exactly and which framework also which is also cool. Yeah, any questions? Oh. Increased from 100 deployable. Uh, controls are the ones that are in. It was like 50 back From the quarter? Yeah, did you open a sport case? I, I think the, um, the, I, I'm pretty sure that they use the same like implementation of the control hook as we have and we've completely rewrote it, um, and so I'm pretty sure that that limit is now gone um we should double check to make sure yeah yeah but we'll take it offline afterward and we'll take your details, no problem, yeah, they, they had to rewrite it basically for like uh we, we wrote rewrote the implementation, um, to support this, uh. Because actually it was really funny, um, the hook, the hook run times used to be constrained to like Java and Python. We added rust guard is written in rust. All of these controls are written in GARD, um, so we're able to like they were doing truly gnarly things with the JVM in order to like run rust, um, but we rewrote it and now I think, um, probably a lot of these limits are gone, but we should definitely double click for that for you. Any more questions? Oh, there are a question in the back. Pence confirmation versus. Of course cloud formation, um, just kidding, they're, they're paying my bills. I would say use, use what's right for you and your organization. I love, I think. For for me for cloud formation you get a lot of safety and like auditability built in if you have like if you're using organizations um and you like you have to manage an organization it's really well integrated with that there's a product called stack sets which basically you can like provision confirmation stacks across um OEUs and accounts by default. I would also say, and I, I don't think this is a huge secret, so I don't mind telling you that like most cloud formation customers are also terraform customers, um, so like a lot of shops just use what's right for like the right thing, yeah, and basically you also you have, uh, if you want to multi multi uh structure you have uh. The solution of teleforms at the factory for telephone, which is also very good, yeah, but what you run into when you like use terraform just from an AWS perspective like I love terraform is that like a lot of work that we do like hooks like are like it's supported with an asterisk so things like that sort of happen, um, but uh yeah so. Yeah. Also, I love the CDK, so like I, I, HDL is fine, but like I love the CDK and I love like writing my code and um type script so yeah. Yeah Cool. Any other questions y'all? Oh yeah. Control to our site, you make a torn instead of failed. It's a wonderful idea. Uh, yeah, so, uh, the technically, yes, uh, and we're working with them to figure out like what the right experience for that is. I think some of that work is like, um, under the, under the covers like the hooks team has been doing some work on like. Back port like um sending invocation history backwards to like the like root account basically so like you can actually do some observability on it and say like hey like ok this is failing for 100% of the accounts that it is deployed into um so we're working with them to support that so that's good. pretty challenging from our side there's all the problems. Yeah. We had on warn right to see like what the stats. Yes, yeah, yeah, uh, I will show you one thing. So we did launch some like, uh, like UX improvements. It's, it's still not, I, I will tell you two things about observability, um. 100, connections. Does anyone have any feedback for Amazon? Um, uh, one is that, uh, we don't talk about this much, but you can actually integrate, uh, like there's an event bridge hook for hooks, so like you can create a any time we invoke a hook, like we'll send, we send invocations to event bridge, you can route it to wherever you want. This is how we're implementing this under the hood for control tower, um, but also, um, we, so you can see. Uh, like, we've launched, uh, this new screen, basically. I don't know why I turn off results. Basically you can see all the invocations that happen in this particular account and see like whether they passed or failed and like what the validation error was the same for the exact reason of like it's actually really difficult without something like this to see like the impact that a worn hook is having. Um, yeah, so, and observability is sort of like the next is observability in organizations more integrations is sort of like the next set of features that Hooks is like really like diving into, um, but yeah. Cool. Any other questions? Cool. Remember to like and subscribe. I mean, fill out your survey on your app, um, for this session if you give us great reviews they give us raises. If not, they put us back in the pen. So, uh, yeah, thank you so much. Thank you.