---
video_id: IMe7SjVwdm8
video_url: https://www.youtube.com/watch?v=IMe7SjVwdm8
is_generated: False
is_translatable: True
---

Uh, yeah, good morning, everybody. Still morning. Good afternoon, I guess. Um, today we're, uh, here to talk about automating certificate management with exportable public certificates. Uh, I'm Zach Miller. I'm a principal security SA. I cover our cryptography services, and Praveen, you wanna introduce yourself. Hi everybody. Uh, my name is Praveen Nayir. I'm a security specialist at AWS focused on data protection and privacy. I'm hoping everybody at the end are able to hear me fine. If not, I'm OK to speak up a little bit. I sometimes speak on a lower note, so please be frank enough to let me know if I'm speaking on a lower note. Thank you. Uh, so that's my introduction. I'll pass it on to Zach. Yeah, so like I said, you know, today we're gonna talk about exportable certificates with a service called uh ADBS certificate Manager. Uh, you may be familiar with this launch, but, uh, the basic idea is that, you know, in the past we had certificates that you could issue from public certificates I should say that you should issue, you could issue from ACM and you could assign those or bind those to resources that were integrated with ACM, right? So you could assign it to a load balancer. Application load balancer or an API gateway or cloud front and customers said, hey, like I have these use cases where I have a firewall that, you know, runs in my data center or runs on EC2 and AWS and these aren't things that are integrated with ACM and I still want to get public certificates to those devices. And so that's why we built this, uh, new feature where you're able to export the private key of public certificates and so I'll talk a little bit about, you know, what that feature is and, and a little bit more detail. We'll go through some of the challenges that we see customers face when it comes to certificate management in general and in particular again with these kind of non-integrated services or devices how you can handle managed renewal or automated renewal and Praveen has some pretty cool uh code and demo that he's gonna show. Um, that we built that shows you how to kind of, uh, automate some of these renewals, right? So we'll talk about public certificates, uh, I'll talk about the challenges with installing them, and, and, you know, a lot of you are probably already familiar with some of these challenges. Uh, we'll go into a kind of a deep dive of the architecture and the code, and then Praveen will show a demo of how it works. And do feel free to, you know, raise your hand, ask questions, interrupt us, that's totally fine. We wanna keep it interactive so if you do have questions throughout, you know, let us know. Happy to answer those. Um, OK, so like I mentioned before. We have the service ADBS certificate Manager. It is used to issue both public and private certificates, and it has this nice feature called managed renewal where again with things like ALB, uh, you know, about 60 days before the certificate is about to expire, ACM will issue a new certificate. It will bind that certificate to the same resource, say like in the ALB or API gateway. And it'll handle that renewal for you, right? And there's kind of two, mechanisms for domain validation. There's email validation and DNS name validation. We highly, highly recommend you use DNS name validation because it allows you to have that no touch, uh, you know, not think about, uh. Certificate renewal experience right where email validation still pretty simple, but you have to click a link in an email and you know many times customers will be on vacation or that person's left the company or whatever whatever the reason is, right, that email somehow gets missed that link doesn't get clicked, you could face an outage or something of that nature, right? We don't want that. So I highly, highly recommend you use DNS name validation because it just means you have to create a, a DNS record, C name record that basically says, hey, yeah, I own this domain, right? Um, and so again like what we saw with customers is they were like I love the managed experience of assigning this certificate to an ALB and a renewal. I don't have to think about certificates that, that's great, but I have EC2 instances where I run Engine X and Terminate TLS there, and I have, uh, you know, maybe Palo Alto NextGen firewall that I use on-prem, and I need a certificate for that. So how do I do that? And they wanna consolidate down to one certificate provider and so we built this feature called exportable public certificates. Um, and another nice feature of it too is you have the same type of access control you're used to with IAM, of course, and you, you know, it's integrated with AWBS Cloud Trail and Amazon Cloud Watch, so you get nice observability on how your certificates are used and, um, you know, kind of all the, the details around rotation and things like that, right? And so when we're talking about like the use cases for this, I, I called out quite a few of them already, but you might have servers or where you're terminating TLS on another cloud provider, and a lot of our customers are multi-cloud. You might have on-premise systems that you wanna get these certificates to, uh. Firewalls is a really big use case we hear about and just other services that aren't integrated with ACM, right? Like, uh, EC2 instances, EKS, um, and just containers in general, and you wanna get public certificates to terminate TLS on those devices you, uh, need to be able to export the private key, right? Because you need that private key to actually terminate TLS. I'll talk a little bit about pricing too, um, uh, this has been a driver for customers to reduce their costs because, um, as some of you, as some of you know, public services can be pretty expensive. Um, and so we've priced it, I think, you know, very competitively where you have each FQDN is, uh, $15 for each cert, and you only pay that once when you export the cert. So you may know already that, um, when you request a public certificate and assign it to an integrated service like ALB, that's a, that's, there's no charge, no charge, right? It's a free certificate. That is still true. Uh, you only pay for the certificate when you export it the first time and then never again until it's renewed, so it's not like, you know, you're paying for it per month or anything like that. You pay for it the first time you export it and then the next time it's renewed, you'll pay again after you export, right? So again, $15 per uh FQDN. So if you have, you know, one.example.com and 2.example.com, that would be $30 right? Go ahead, yeah. Can you Is it the same if you had multiple sands to a certain? Yes, good question. Exactly. So say you had the, you know, the regular common name, and then you had two sands, that would be 3 FQDNs. So $45. Yep, hm, is that a one-time fee for the export, uh, one-time fee for the exports. You can, you can export that as many times as you like after that. Yeah, absolutely. Uh, just the one-time fee and then the next time that certificate is renewed, like the next year, it's technically a new certificate, so you would pay that again. But, but yeah, so you can continue to export that certificate as many times as you need. Is it billed at the time of generation? Like, is it flak is exportable, and that's because it's flak is exportable, it's billed for. Uh, no, that's a good question. So I'll repeat the question just so people hear it. So you know, the question is, uh, when you create the cer certificate, if you mark it as exportable or you build, then no, you are only billed the minute you export it. So when you call the export certificate API and you get that private key, that's when you'll be billed. So then in theory we can, we can flag everything that's that's exportable. But as long as nobody actually goes in and actually exports it, yes, that, that is true. The only thing I would say there is a bunch of customers when we talked to them, said, I don't want you to, like, I don't want my developers to just export any certificate, and so you have to mark it as exportable when you create or request a certificate. So if you originally request a certificate and you say this is not exportable, you will never be able to change that. I mean, you know, you could reissue a new certificate for the same domain, but you won't be able to then change it later. Um, and so my only kind of word of caution there is if you have that use case where you're like, uh, uh, you know, some customers view it as a security feature that you cannot export that private key, right? And so I wouldn't necessarily advise putting everything exportable unless you have a use case for it, but yes, you, you could definitely do that, sure, yeah, absolutely, sure, um, maybe I'm getting ahead of myself here, but if I wanted to test the lifes I pulled up a certificate. Including exporting, but then I don't want the certificate for like the like a couple of days at the most, but I have to basically pay for a whole year, right. Yeah, effectively, yeah, yeah, there's no, it's not, it's not prorated in that way, yeah, unfortunately, yeah, there's no way to get a shorter. So there, so there is, OK, so, so there's two services, right? There's ADBS certificate Manager. It issues public certs and private certs. There is ADBS Private CA, which we're not gonna talk about too much in this session, but you can absolutely, uh, there's a short-lived certificate mode for that, and those certificates are priced at a. Lower price per certificate and they only live up to 7 days so that would be like for customers that you know hey I have a Kubernetti's workload. I rebuild my pods every single day. I don't need a cert that lives a year. I need a cert that lives a day and I don't wanna pay for a cert for a year. So you can do that with private certs with ACM at least today, um, they, the, the certificate template is kind of set in stone and it's, uh, uh, 3, what is it 365. Yeah, 13 months. Yeah, 13 months, sorry, that's right, 13 months. It's a 13 month certificate, so, uh, you can't change that validity period today. Uh, I can't say a whole lot more, but we're thinking about other ways to reduce that because, as you may know, the, the cab forum has made some changes where they're gonna reduce the, uh, certificate lifetime. So we will of course adjust our service to, to deal with that. What about the pricing. Is it every 30 days? That is also a very good question. So I can't say exactly the here if you talk to me in the hallway after, I can probably give some more detail, but yes, we will be addressing that. There will be a pricing change that will reflect the, the, the shorter renewal periods. Yeah, absolutely, because the first drop was like here in March or April 200 days. Yes, yeah, I, I can't say too much, but yes, if we talk, talk, come find me after the hallway, we'll, we'll talk in more detail, but yes, we are absolutely, um, planning for those changes, and, and the pricing will reflect that, and customers should not be paying more, uh, based on that, hm. So prior to the export of the rack, he it's in HSM. Uh, well, yes, so, so, OK, so the way that ACM works basically is when you create a certificate in ACM we generate a private key and we wrap or encrypt that private key with a KMS key in your account. So there's a KMS key called the ADBS managed key. It has an alias that says, um, it should be ADBS slash ACM. And that key is actually used to protect the private key in your account, and that KMS key is, uh, protected by PIPS 140-3 level 3 validate HSM. So it's no longer HSM. That's right. If, when you export the private key, you, it, Praveen will show this, but it is, uh, exported encrypted. You, you basically set a passphrase when you export it, but yeah, it will not be, it will no longer be. Uh, it will be exported from the service so it wouldn't be protected by NHSM, right? And so Praveen will get into this a little bit on how we recommend securing those private keys, um, but yes, you're right, like once you export that key, that's kind of what I was getting alluding to earlier with the security. Uh, consideration why you probably don't wanna mark all of your searches exportable right away just because that does allow, you know, application teams to export that private key if they want to, and you probably wanna make sure there's actually a real use case for that, you know, to, to limit risk of key compromise. Good questions. OK. Um, yeah, so the only other thing I think I didn't cover is the wildcard certificates. So wildcard certificates are priced a little bit differently at $149. So. OK. Um, probably a lot of you, well, yeah, you're good. So if I have the I have signs, um, attached to that. Am I being charged 149 the first time? Sorry, say that one more time. So I do have, you know, alternative. So right now I will do that I have 3 at home. Yeah, so, so say you had 3 sands and then the regular common name, that would be 4 FQDNs, so it'd be 4 times 15. 44 times a year. No, no, because the wild card certificates, uh, there's no, basically the wild card you wouldn't have sand, you wouldn't be charged for the sand in that way. It's the flat $140 140 dollars, yeah, yeah, so wild, uh, no, you cannot do that. You, you, so you could only protect the one subdomain with, so like debt, you know, foo.example.com, bar.example.com, but not food.bar.example.com. Yeah, that's right. Um, so let me, let me ask, so who, who here deals with certificates daily or at least a lot, you know, probably, OK, probably everyone's familiar. Anyone, um, have the experience of, you know, creating Outlook calendar reminders to, to renew your certificates? Oh yeah, yeah, I've been there. I've been there too. So, you know, I think that's, that's the obvious example of, of some of the challenges, right? You have things I talked about before like if you have manual, uh, processes, you have a human being that has to go manually type in that cert and put it into a key store and you know, it's all kind of all this whole manual process. Obviously there's a lot of room for error. Certs and TLS tend to be a little bit finicky as, as probably everyone knows. And so, you know, we, we do see these challenges from customers and that's why we originally built ACM. Um, and then of course why we, we built this feature to, to export, uh, the private key and so aside from even just those manual installation challenges you have things like all these different environments, right? You have Engine X running on AC2, you have your different load balancers and proxies and all these things where you might need to put a certificate and you know there's not a super consistent way always to get the certificates where they need to go basically. And then you have things like renewal gaps where you have an expired certificate that leads to some type of outage and you know TLS stack's broken and you're, you're not able, you know, uh, your users aren't able to access your service, right? And so those are the things we wanna avoid. We wanna get to a place eventually where customers never have to think about certificates. It's just kind of an automated thing where they get renewed, they get a placed where they need to go, and that's kind of what the solution that Praveen's gonna show is, is attempting to do. And so when we look at, you know, what we wanted to, kind of the requirements we're looking to, um, you know, achieve when we built this, we wanted to look at things like event-driven, uh, architecture, right? Make sure that you have the ability to manually renew if you need to, but we really want it to be automated. We want it to be based on those cloud watch alerts, um, and event bridge alerts that are published when a certificate's about to expire. And so you'll see when Praveen shows the demo that there's kind of two ways to do it. You can manually renew or you can have a lamb or a, you know, a beverage rule that's basically listening for these, um, these events that say, hey, the certificate's about to expire. You need to trigger a lambda, and we'll, you know, you'll see, you'll see the details of everything, but, um, you need to actually export that cert and place it where it needs to go. Um, we also wanted to make sure, of course, that that private key is secured. Um, you know, when you do export the cert just like every other AD ADBS API, it happens over HTTPS, so it is, you know, encrypted in transit, but you also, uh, specify a passphrase, and that cert will be encrypted with the passphrase. And in our case we store that passphrase in Secrets Manager for, um, you know, more secure storage. Um, yeah. And so when we get into these two types of workflows like I talked about. We have the on-demand kind of method, which would be, you know, hey, I'm going to manually renew this cert. Maybe it's some type of compromise. Maybe you just have a requirement where you need to manually renew it, uh, you know, earlier than you expected. And so you're able to trigger an API on it, uh, and, and just kind of manually renew that cert, right? Or I shouldn't say manually, but manually trigger the automation, I guess is more accurate. And then you also have, like I mentioned, automated certificate renewal where EventBridges, is doing that trigger and we're listening for that, and we'll kind of uh in an automated way export that cert and put it where it needs to go. Any other questions before we talk about architecture? I Oh yeah, there's support for like centralized like a single domain in an organization where I can. Single domain for. Right now we learn a lot of stuff. Yeah. Yeah, so, so, yes, so, so you can, you know, when you export that key, you could definitely put it on a device in another account. Uh, does our solution support that? I think it does, yeah. Do you wanna talk about that? So what's the question? Uh, sorry, can you repeat that? It's hard to hear. I make it more like automation. I don't wanna have to. Oh, I see. Yes, you can do that and I'm gonna talk about that. Yeah, yeah, we'll, we'll get into that in a second. Go ahead verify ownership of the wild. Uh, so we use domain validation, so you need to create a C name record that proves you own that domain when you request the cert, regardless of whether it's wildcard or not, yeah, and you could also use email validation again, it's not really something we recommend, but, um, yeah, either way. Typically if you use Route 53 for DNS, uh, ACM will actually go and create that record on its own. Like you don't need to it's kind of a one click button or it'll do it on its own, whereas, uh, you know, you may need to update your DNS records manually if you have another provider. But yeah, as long as that CA record is there that, that proves you own that domain, we'll, we'll, we'll validate it and issue the cert. Any other, oh yeah. OK, you did mention that you can do the one-click update, but there's also a lot of times where your ACM and your rep free zone are in different accounts and causes problems. Have you guys thought of, uh, any solutions about allowing, um, RAM shares or ACM so that it can be shared across multiple accounts to make a lot of that easier? Yeah, it's a good question and that is something that customers have challenges with. So the question was about, you know, I maybe I have Route 53 zones in a different account that I'm issuing the certificate, and it, it doesn't have that same kind of integrated seamless workflow around creating the C name record. Um, maybe let's talk in the hallway in more detail after, but yes, that is something we're aware of. What, what I often see customers do in that case is. You know, as you probably know, when you issue the certificate, it, it publishes in the event bridge, um, notification. There, there's this basically the C name information you need, and oftentimes customers will have to kind of like create automation on their own to grab that record, put it in some kind of central repository, or feed it into another account and create the record through automation. It's like assume a role in another, in the other account and do it, so. There are ways customers do it today that are, um, you know, workarounds that you have to build. We're looking at ways to make that experience easier, but it's not something I can talk about right now. But yeah, it's a good question. Um, OK, oh yeah, sorry, go ahead, uh, you mentioned that the branch that it's flexible. Sorry, you said on you got a speaker, uh-huh. To understand, does that mean it's so before we get into any of the on-rem instances or Yes, so, so Praveen will go into that a little bit on how we do that, but, but yeah, like, so when you export that private key, I mean, obviously you can put it wherever you would like, right? What Praveen's gonna talk about is how the sample code we've written, uh, helps you actually install that certificate securely on, for example, like an on-premise server, um, so he'll get into that. So I'm, I'm not gonna get too into it because he'll, he'll get deep into that and show that in practice, but yes, you can absolutely do that for on-premise servers as well, yeah. OK, I think I'll pass over to Praveen. He's gonna talk about the architecture and then he'll kind of do a deep dive into the code and the, the demo. Yeah, so I'll. I'll go over the architecture diagram. So, uh, we, so this is our, there are two workflows to this solution. One work, this is the first workflow. This is on-demand certificate. What it requires is you already have a certificate issued with ACM, uh, with DNS validated and it is issued. Once you have the certificate, you need to have the ARN of the certificate. You're gonna, what we're gonna do is we're gonna have an API gateway, which will take an API, uh, we have an API template which we will share. It is there on the sample code as well. Uh, you pass the certificate ARN and uh certificate name, details, and what the solution actually does is it actually goes and installs the certificate on EC2 instances. And this can, it can do this at scale. So if you have multiple EC2 instances, you can install it on more than 1 EC2 instances as well. Because it's tag-based, so what it's doing is using tags to identify which EC2 instance it needs to go and install. And what it's using, what we are using internally is actually Systems Manager. If is how many of you here are familiar with uh System Manager? OK. So for the folks who are not familiar with Systems Manager in AWS, it's basically a management solution that people use to manage their fleet of EC2 instances. Uh, if you have multiple EC-2 instances, you want to patch them, you want to run ad hoc queries on, uh, commands on them, you could do that, uh, with Systems Manager. Um, so it has a concept called as automation document. You can write your custom uh commands or scripts in that automation document, and you can run them at scale across multiple EC2 instances. So there's one gentleman asking about on-prem, right? So Systems Manager can also manage servers on-prem. So you could actually uh manage some of your EC2 instances through um uh some of your on-prem servers through Systems Manager and run the commands and install the certificates on-prem as well. Going back to our solution, what we're trying to do is, it's, we call you, the first instance you call the API, you tell what EC2 instances you need to uh apply the certificates on. You give the name of the certificate and you give the ARN of the certificate. That's gonna trigger a step function. A step function has 3 lambda functions. The first lambda function is to actually go and export the certificate from ACM now. For exporting a certificate from ACM you need to pass a passphrase, uh, which means the passphrase actually encrypts the private key as it comes out of ACM. Like I said, like Zach was talking about inside ACM, the private key is encrypted by KMS. Once you bring it out, it's not encrypted, so you. We give you uh an encryption with a passphrase, so it's encrypted and you, once it comes out. What we have done in this automation is you don't have to create or do anything with the passphrase. We will generate a dynamic passphrase which even the user is not aware about. We're gonna take that passphrase and we're going to store it in Secrets Manager. All right. And then we are gonna take the, uh, take the private key and the public key, and we're gonna pass it on to the 2nd lambda function. And we are also, if you see there, there is a Dynamo DB table out there. What the dynamo DB table does is it actually stores the metadata about where the certificate is being installed. A lot of times when you export certificates out, People or customers tend to forget where that certificate's gone. I do not know where the certificate is right now, right? So what that Dynamo DB table does is it stores exactly the tags, where the easy to instances, um, which EC2 instances those are installed. It has the ARN. It has, um, it has also got the expiry date and everything inside that. So if anytime you want to go and check, hey, how many certificates I have exported, where it is, what EC2 instances it installed, all that is there in the Dynamo DB table. Once we have that, we pass the uh certificate details like private key, public key to the systems manager automation doc. Now, this example installs it on a Linux machine. Which is a normal Amazon Linux machine. It goes into the cert folders and installs it. You could modify the automation document to do it, do an installation, clean installation on an EGX server or any custom application that you might have. It's just a bunch of commands that you have to run. You can do it. You can do it for uh Windows as well. Uh, if you have an iIS server that you want to update the certificate to, that's just another automation document, right? If you want to move that certificate outside to another cloud provider, you could do that too, but you may not be using uh Systems Manager at that point. You might have to use a different solution. So I'm kind of looking at trying to move the certificate into an external vault or somewhere from where it can be integrated by other cloud providers as well, but that's an extension I'm working. Which I'll, uh, which I'll be working on for the next year, and I'll have a solution on the samples updated with that. But for now, it does it on easy to instances and it uses Systems Manager. And if you're planning to use any of this and you have a specific application or anything, uh, absolutely feel free to reach out. Um, I'm happy to help out if you're, uh, looking for any assistance or direction on how the code should look like, right? It is also open source as well on GitHub, so you know, feel free to contribute as well. Yeah, and it's a, so yeah, it's a GitHub resource if you have questions you can do, and I'm gonna share the link where it is available and it's in AWS samples. So one of the key things of exportable certificate is that once the certificate is exported, Um, it's customers, it becomes, we, we work on shared responsibility model. Once you export the certificate, it's customer's responsibility to secure that private key. So, like I talked about, we did two things to make sure your private key is secured. So first one is, like I said, we generate the passphrase for you, and we store that passphrase inside a secret manager in the secret manager. And then we also tag the secret manager, uh, same, uh, that secret same as the EC2 instances, uh, instances. And what we are doing is actually we are doing ABAC, which is attribute-based Access Control, which means the EC2 instance tag, uh EC2 instance profile tag, and this uh secret tag needs to match for the EC2 instance to get the passphrase and decrypt the private key and use it in the application. So it's not like I put a secret somewhere and any EC2 instance can go and access that secret. It's attribute-based, so only specific EC2 instances where the certificate is installed, only they can go and access that secret to encrypt or decrypt the private key for their use, right? So those are the two key things that we give uh with this solution. Any questions on this? Until now. Yeah. It would not go to auto discover existing certificates that that we haven't solved. For example, I have my certificates that once a year for renewal. Um, would all this cover that, or do I need to? No, so it, it, it cannot go in auto-discover certificates. Um, it's only if you issue the certificates to ACM and you want to export it and install it outside. That's the part that is going to automate. And It's going to do a second part of the solution, which is. The renewal renewal of the certificate, right? So what we have is we have an event bridge rule. Uh, created with the, with the cloud formation. What it does is looks for the event when the certificate, the public certificate is renewed. So your, your public certificate, which is exportable, they are basically renewed 60 days before the expiry. So, before the certificate, so 60 days before when the certificate is renewed and issued, it will trigger off a job which will, where we call our lambda function. And that lambda function actually uh takes the certificate ARN. It's able to look up based on the ARN whether that certificate was exported and installed on an EC2 instance. If it is, then it is going to take the relevant details from the database, and it is going to trigger the step function. And then the process is the same. It's going to export the new renewed certificate. It's going to create a passphrase for it. It's going to update the passphrase in the Secrets manager, and it's going to go and install those certificates exactly where it installed last time. Running the same scripts. So what this means is you do not have to worry about renewal of the certificate, even on your EC2 instances. This solution is going to automatically identify that and go and install it on your EC2 instances. And uh obviously we have logging and everything enabled, so if there's any issues or anything, you will be able to go and check that and create alerts based on that as well. Yes. Um, so can we use the tags to identify the server that needs to Would it read the tags and I say hey this is my server that uses this is a good one. So there's so there is a little fundamentally, there is no way based on tag or instance for us to identify what certificate is on that server, unless you give, you create an application that actually goes and does a grip across different folders and identifies the certificates on there. There is no easy way to identify what cert is installed in which uh server uh without knowing who put it there or where it is. There are solutions, third-party solutions that try to do it. The other way I've seen people do it is they identify the endpoint and try to do a TLSNC, get the certificate information based on that. Possible, yeah. So if you, even the agent will actually I have to do a grip or something across the disk to identify the certificate, that is what certificates are already stored on that device. So this solution doesn't do that. It, it only takes the cert it takes the exportable certificate, installs it on EC2, and then it also renews it for you at the end of it, so. Alright. Sorry, say that again. This is a proof of concept. That's right, yeah, this is something that, um, yeah, we built, published on GitHub as a sample code for customers. Yeah, that's right. The portable certs feature, of course, is a, is a feature that, you know, the ACM service team built, but what Praveen's showing today is, is something that we built, um, and to the point about like certificate inventory, I, I would agree with Praveen that. I typically see customers use partner solutions like maybe familiar with like VenFI or AUX to uh go out and discover where certificates are placed um and as far as Acme uh today ACM does not support Acme. Let's talk after and we can talk about roadmap but uh today Acme is not supported by ACM. Yep, uh, we're being recorded, so I can't really talk about roadmap, but we, we here, we're a customer obsessed company. Many, many customers have asked for Acme, and you can, uh, you know, infer what you will from that. Yeah. Um, So the next part is a cross-count, like some of the questions over here, how does it work cross-count? So, yes, this solution does work cross-count. Uh, you have a cloud formation template, you have to, uh, there are, there are a couple of cloud formation templates in here. One is to do the central. Account implementation, which is all your step function and everything is in one account from where you want to issue your certificates and stuff, and then you just create some IM rules for cross account so that your systems manager is able to go and Um, run commands on your EC2 instances and then also your EC2 instances once created, are able to go and access those secrets that are creating in that account. So what is, what is the important thing here is the passphrase is actually stored in the same account as the where the EC2 instances it is. So we don't want, I didn't want the, uh, the EC2 instance to go back and get secrets from another account. So that's why we, um, kind of cleaned up the solution to do that. So that's, that's the solution. All right. Yeah. So that's the link uh for the GitHub code. So if you scan it, or if you just look for ACMs, sample ACM export certificate automation in AWS samples, you will find the solution. It has a very detailed read me. It talks about uh how to do the installation, how to, how to test out the installation and everything. It's very detailed. And if you still have any issues, uh, feel free to add and comment or something on the, on there or just reach out to me based on the email that will be shared at the end. All right. So now I'll switch, uh, I'll switch to the demo mode to show exactly what we are doing. And, uh, before that, um, yeah, thanks. This is Quiro. So I built this solution in Quiro. I know Quiro is something everybody's talking about today. If you haven't tried Quiro, definitely try it. Um, it's based on VS code, but it's still, um, it's still, it's, it's pretty useful. Um, so the template that you're seeing over there is, is the template for calling the API, um, so like, like I said, it takes, it takes the certificate ARN, it takes, you can give it a name. And then you can, um, you have to give the target, um, the tag values which is ENV and Dev is the tag value that I'm using and the target account. So the account where you want to go and install the certificate as well. So you could do, uh, you have to give these values and this will trigger the step function. So I'm gonna sit down and. Um, do the demo. Uh, if you have any questions or anything, um, raise your hands and, um, let me know. The, the API gateway is actually uh IAM protected. So, who calls the API? The person has to be, uh, has to have the right or valid uh uh IM role to actually invoke the API. So that's a security. It's not like anybody can export the certificate and put it on any easy to instance. So we have added a layer of IAM as well. So what I'm gonna do is I'm gonna use AWS curl command, which basically takes my IM profile, which is on my desktop and uses it to call, um, call directly instead of me passing. Uh, the SDS tokens, uh, through curl command. So that you can see the execution ID I'm gonna. Come here. So that started the execution of my code. Um, so first is the export cert. We have the input of the certificate ARN on all the details. What it did is actually it exported the certificate, and it also did is it added the secret in the secret, and this is the whole encrypted public-private key that you're seeing out here. Um, and this details is now, so if you see the certificate name is demo December 2. After that, it, after creating everything in the secrets manager and stuff, it's going to call this, it's going to call the Systems manager for the automation document. Um, so, I'm passing all the certificate details to, to the systems manager. I'm sorry. And, um, it's It's gonna execute and it's gonna, if you see here there is an automation execution ID that means that the execution has started, the automation execution has started. This is a cross account deployment. I'm on uh account starting with 70 and this is gonna install on another account, uh, which starts with 090. So, uh, you could see that it's going to going to do a cross account. OK, perfect. Yeah, so we do have examples of cross account there. Great, yeah. So A lot of times the automation takes some time if you're installing on multiple EC2 instances across, so there is a weight section on that. It basically waits for the automation to uh document to complete successfully. And once it has, uh, the automation status completed, um, it just moves to success traits based on the number of EC2 instances. If it fails to install on any 1 EC2 instance, also, it will generate an error. And you'll have to go back and see in the systems manager as to what exactly happened there, right? So this, this code is going to do all that. What, so This is the Dynamo D TV table. And I told you that it's gonna have all the details of the certificate. So it has a key, a primary key. It has the certificate ARN. It has the certificate's expiry date. Um, it also has the, um, the certificate name that you gave. So in this case, we did a December 2, so that's the one. It has the details of where the passphrase is stored, of your secrets manager, where the passphrase is stored, and which target account that, that uh certificate is installed. Even that detail is available in the database. So if you want to check anything, what's going on, you can do that uh from here. Any questions until now? So I'm going to the other account. Yes, so that's the, it expandable. Yes as well. That's a good question. Um, I actually was trying to do that, whereas, um, I got, I didn't get any customer feedback on people who wanted to go on AC2 clusters. Um, but if you, if it's an AC2 instance, and you can run an automation document on it, you will be able to install it anywhere over there. Yeah, the, the code is, is it is it exists today. Doesn't have, um, like run documents like Praveen mentioned for ECS, but there's no reason you wouldn't be able to, you know, that's good feedback, and I think we can adjust it to, to include that because, yeah, like you will definitely be able to put that private key on an ECS task, but, um, we haven't, we haven't built that into the solution as of right now, yeah, yeah. I You have a custom solution for what? I'm sorry. Service mesh, um, no, I don't think we did that, right? No, so, um, you mean for like, uh, the MTLS between services, yeah, so, so really public certificates, which is what we're talking about today, you, you can no longer really use them for MTLS because you might be aware of the another cab forum change recently was that public certificates are no longer allowed to have what's called the um client off extended key usage which is necessary for MTF MTLS. So this particular kind of solution and public certificates would not work there. um, I mentioned a service ADBS Private CA earlier that you can absolutely issue private certificates of any template and you know as long as it's X 509 you can adjust that template however you'd like and so we do have customers that use that for service to service communication. Um, there was a service called ADBs App mesh that, uh, would sometimes customers would use for that. I more commonly see customers use partner solutions like STO today. Um, so yes, but, but you would not. Nessarily be doing that with these public certs as as you're not able to anymore um that would be something you would look at private certs with ADS Private CA or you know Windows PKI or something like that um any time you're using a private cert that's where you would do that MTLS between services, for example. So, this is the EC2 instance. It has the tag ENV and dev, so it's gonna go, it went and installed it on this one. this is the instance profile uh of that EC2 instances, basically, what IM roles that EC2 instance has. And if you see, this is the IM policy that was added to the EC2 instances, which is using tag-based access to actually go and access the secret that is created by the sys uh by the automation at this point. So if you go ahead and check for the secrets over here, you will see that it has created a secret. Right now, this is a new brand new secret created which has the passphrase. And it also has the tags attached to it. So basically what it did is it went to the other account, it installed the certificate, and I can show the certificates that are installed over here, and this is exactly what I didn't want it to happen. So it logged me out. Uh, all right. And, um, uh, we can actually go and check the certificate. So I have commands ready on that, uh, So right now, it is installing the certificates on EC2 SSL certs doc uh folder in, in this uh Linux machine. So if I run the grab, if you can see those, those two certificates, so this is the public certificate, so it has the full chain of the certificate and the certificate as well in there. And then the private key actually um goes in another folder which is SSL Private. Over here and that's the private key that is installed um in that server which is cross account. Now to access that uh certificate, I have a small script uh which will actually extract the passphrase from the secrets manager. Um, And I can use that passphrase now to actually decrypt. The private key. Just that. So, a lot of times, some applications ask for private key, uh, unencrypted, or some ask for private key with a passphrase inside the application. So depending on how you want it, you could, your EC2 instance now has access to retrieve the passphrase and, uh, uh, do the changes on that part, right? So. So that's the cross-count part. So this is the part one of the solution where you created a you exported a certificate and installed it on an EC2 instance. Now, the part two of the solution is the event bridge. Uh, part. So, when, when you install this cloud formation template, this service actually installs uh event bridge rule, which actually looks, uh, looks for a specific pattern. Now, I modified it. If you look at the source over here, it says test. But when you actually run the cloud formation template, it will be ACM service. Now, why I did that? Because I want to manually invoke this event to show the flow. But when you actually um do it, you don't, you don't need to do, uh, run it manually, right, for testing purposes. As soon as the ACM uh generates the event, your flow should be, will be kicked off. In my case, um, for it to renew and do the step, it takes a few minutes. And um so it won't be, it's not good for demo purposes, but that's why I changed the source to test. So what I'm gonna do is I'm going to trigger this event, and this event is actually going going to go and trigger and step, a step function. So let's look at that. So that is command on how to trigger this event as well, uh, inside the code sample that I showed you, that is, uh, that is there. Um, so let's run this, uh, from here. Yeah. So that should have triggered an execution. Over here. Uh, I see. So It's running 3 executions because the ARN of that certificate is attached to 23 different EC2 entries. So it's, it's going to renew it in all 3 places in the database. So that's why you're seeing 3 instances. But um. What it's doing now is it's actually doing the same steps. It got the details from the Dynamo DB table as to where that, where all the certificate is being referenced, and then from there, it's actually taking it and moving it to uh and taking those details and going. Installing it as is, so this is basically hands off just like application load balancer cloud front. Once you install the certificate with ACM, you just forget about it. It renews on its own. Similarly with the EC2 instance, this solution can renew on its own as well. So that's. That's how this would work. Any, any questions on any of this at this point? Yes So the only prerequisite for this to work is to make this certificate exported, right? Yes. OK, it's because we have a few certificates that are. in AWS and er no balancers so this will work fine for the er code balancers if if the certificate. Yeah, so if you have services that are already integrated with ACM like application load balancer, cloudfront, API gateway, etc. for those services, you don't have to worry about it. Um, it will just, um, yeah, it will, it, it does it out of the box. The problem comes when you export the certificate and move it on easy. I have customers who are also trying to use this solution. Uh, to export the certificate and put it on a, on a, on a S3 bucket or somewhere for a third party team to pick up the certificate and install it on some custom solutions as well. Because they don't want to do the automation to go and install it directly inside somewhere because they have a very specific use case. All they want is a self-service where somebody requests the certificate and go. You could actually modify the IM rules and policies as well, and the lambda function to allow specific teams to only request specific certificates based on their tag or naming conventions as well. So you could add that customization. In the lambda function side as well. So if you have those kind of uh requirement, um, you could do the modification or if you need any help around that, if there are a lot of requests coming in saying, hey, I want to see that, you can do that because I was playing around with that and yes, you could actually. Do a little bit more fine grain access control on how the certificates are. Yeah, it uses IM condition keys, so you would basically write a policy that says, um, you know, only A Team A can request certificates with the domain name example.com and App Team B can request certificates with, you know, food. Dot com but not example.com right so you can create condition keys like that um in IM policy and or SCPs for example or service control policies to limit that as well as things like key um key type right like RSA versus ECC and and things like that so you can, you can get fine grained with those permissions, um, and to your point about like having the certificate on a managed service as well as on-prem. Um, even if the certificate is marked marked as exportable, manage renewal with integrated services still works the same way, so it would still be renewed in the same way on, say, like your application load balancer, and then you would also get a notification through EventBridge that, hey, a new certificate is available for export, and you could either, you know, manually export or use a solution like this to, to, you know, grab it automatically. Through that granular control that you were just talking about, would it be possible to. Uh, restrict requests for wildcards to still allow the route naming convention. This, uh, you know, so any FQDN at the subdomain level is fine, but not the wild card. Yes, yes, you can specifically restrict wild cards from being issued because some customers say, you know, I don't want my customers or, you know, my developers to ever issue wild cards. Yes, you can absolutely do that. Yeah All right, I'll switch it to presentation. Yeah, so let me kinda wrap up here and then again like if folks have other questions feel free to ask. Um, we have about 9 minutes left and then after that we'll, we'll be out in the hallway if you wanna talk more, um, you know, particularly about road map stuff we can absolutely talk a little bit about that in the hallway, um, so yeah, just key takeaways that you know we want you to remember after the session. Obviously you know we want you to think about this uh new feature from ACM exportable public certificates. Think about, um, you know, how you're gonna manage renewals for certificates that you export the private key for whether it's something like this or a more manual process, um, you know, obviously we want you to get to this place of, of automation, um, when you can, but it, it's becoming more and more important like we talked about with those CAB forum changes, um, you know, someone pointed out I think in March it's going down. The 180 days and then I believe by 2029 it's 47 days, right? So you know for customers that are doing this manually if you have hundreds of certificates that you have to renew manually every single about every month or so, you know, a month and a half, that's not super sustainable, right? And so, um, even if you're not doing all this through automation today, you know, we're, we're definitely encouraging customers to start moving more towards, um, automated solutions for replacing these certificates. Um, and then the other thing would be, you know, when we're looking at, you know, when you look at that sample code, um, you know, we just want to keep in mind that you wanna protect that passphrase or that private key because that's how it's works, you know, encrypted. Um, and you wanna, uh, kind of limit the risk of that public key being put accidentally somewhere and then being able to be decrypted, right, like blogged somewhere in your application or accidentally put on GitHub or something, and so, you know, you wanna protect that with a passphrase and store that passphrase in a very, uh, secure place and that's why, um, when Praveen and I built this sample code, we, we put it in Secrets Manager and we specifically generated it through, um, uh, there's an API in Secrets Manager called get Random Password. Uh, or yeah, I think it's get random password and so you, um, you know, no human being has sees that secret. It's put in Secrets manager and you know, even your developers and whatnot shouldn't be able to access that. It's just the automated service can access it. Um, and then I think like another piece is, you know, we, we designed it with the tag-based, uh, approach just because that makes it easier to understand, you know, again like where are these certificates placed, which EC2 instances have which certificate, and through those tags and that Dynamo DB, um, table that that Praveen mentioned and showed that's kind of how we're, we're looking at that, right? And then, you know, last thing would be. Uh, of course, like with the, with the question around ECS, there are gonna be some customizations for this, and this is just like we mentioned earlier, kind of a POC sample code we built. So, um, you know, definitely feel free to reach out to Praveen and I, or, you know, contribute back to the, to the GitHub code and make our, make our life easier if you wanna do it for us, but we're happy to do it, uh, as well if you have specific things you wanna be, wanna see added to this. So just let us know. Um, also, um, just to add to it, Zach, right, so if you have solu if, uh, is anybody over here looking to actually use ACM certificate outside, uh, AWS environment like on a third party cloud provider and stuff like that, like, OK, on-prem, on-prem is fine. On-prem, yes. What about As your stuff, yeah, so I'm actually working on something where it moves it to the vault over there. Um, there is recently some new, uh, IAM method that has come out where you could actually, uh, generate JWT tokens, authenticate to a third party, and put stuff in there. So I'm trying to work on that, but that's something we can talk about after the position. So you say that in that case, uh, I don't know that we've tested that, but I believe that should work right if, if the, if they have VMs in another cloud provider that are managed by SSM that should if, if you have an if we just run an automation against it then from SSM. So the way SSM works as long as there is an agent running there and it's connectivity back is there, it should work. Um, that's how on-prem works so I don't see why it wouldn't work on any other cloud provider, but yeah, yeah, as long as the agent's installed and has a network path and you know access to to the API and whatnot, yeah, absolutely should. Alright, um, OK, any other questions or anything before we wrap up? Happy to answer anything. um, a link or something to the code on your yeah, will you throw that back up? Yeah, just go to the next slide yes, thank you. Yeah, right there Yeah, you can grab that. Or I think if you search, um, ADBS samples export cert automation, it should come up as well. But yeah, that, that's the GitHub link there. Yeah, even if you look up, do a chat GPT, it actually brings up that solution. I've seen it. OK, cool. How do you automate certificates in AWS? One of the solution is that one. I did not know that. That's neat. All right. OK, any other questions? awesome. Well, I appreciate your time. Thank you very much and feel free to find us in the hallway if you have other questions, wanna talk through anything. Thank you. Thank you, thanks.