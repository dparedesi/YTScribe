---
video_id: zlV6IxLI2Pg
video_url: https://www.youtube.com/watch?v=zlV6IxLI2Pg
is_generated: False
is_translatable: True
---

All right, uh, good morning, everyone. Uh, my name is Mark Klein. I am a principal product manager here at AWS, uh, in charge of payment cryptography, and I'm joined by Philip Wetdy from, uh, from PayPal POS, and we're here to talk to you about PayPal POS's experience getting rid of their HSMs and moving fully to the cloud for their payment processing. Uh, just a quick introduction to AWS payment cryptography. This is our, uh, cloud-based solution to securely, um, processing card transactions, replacing physical hardware security modules or HSMs that customers traditionally had in their data centers. AWS payment cryptography is used for use cases like card issuing, transaction acquiring, which Philip will be talking about. Also issuer transaction processing and it provides many if not all of the same functions that traditional payment HSMs provide, such as translating PCI PIN data using duckput, decrypting P2PE data, managing keys, importing and exporting, also on the transaction processing things like generating CPV-2s and validating ARQCs. This is presented as an API based service, so it is all restful APIs. It is an elastic service you can get started using it in just a minute or two, so no need to provision hardware, and it's integrated into many of the AWS tools such as AWS IM, Amazon Cloud Watch for monitoring, as well as AWS Cloud Trail. Some of the some of the benefits of the service, uh, before Philip talks about his experience and, and PayPal's experience, uh, some of the benefits removing your dependencies on dedicated payment and HSMs, allowing you to migrate your critical payment workloads, reduce your operational, uh, burden by using a fully managed service that is PCI PI P2PE 3DS DSS compliant. Harness high throughput and low latency. This is a completely elastic service. You can just use it and it will scale up and down automatically based on your usage and your your customers' usage and simplified setup, as I mentioned, no need to provision hardware, buy hardware. You can literally just use the service in a minute or two. Now why don't I turn it over to Philip who's gonna tell us about PayPal POS's experience using payment cryptography. Thanks. So, who are PayPal POS, so we were originally founded as Zetel in 2010, small Swedish startup, primarily doing car terminals which you can attach to your mobile phone, so you can sort of quickly start taking payments. Our sort of standard merchants are ice cream shops. Beach, yeah, any kind of beach shops, we have a sort of very seasonal market that we have a lot of summer weather and it's all in-person transactions. So this is sort of our offering, very simple, little reader, takes pin transactions to show us why we need payment cryptography. And where are we live? So, we've been in Europe and North America with Mexico, and as a result of that we've sort of wanted a global presence for our data center. So we've been running, and by we I mean my team has been running the data centers in 3 different locations, and here we can see what we have. So. We have, we try to sort of have a fully redundant setup within each data center, so we have a couple of switches coming in with two fiber lines going to 2 HSMs, so in theory we can lose 1 HSM and 1 switch in each region without losing any dependency. Uh, we also, yeah, so this is what we have in every one of our regions, so we can also fail over between our regions. So, we, as I sort of mentioned, we're a very lean team, so we're a very small team, but we sort of have very high vertical ownership, so the, my team sort of owns the incoming payment gateway, the acquirer service, the crypt, what we call the crypto service, which was our. Interface to talk to the HSMs. And we sort of and we own sort of the data center and the setup there. So why were we looking for a new solution? So I want to go back to it, it's the lean team, so I, I remember on my first day when I started, I suddenly talked to my, met my new team, and they said, hey, this person's given their notice and they're leaving in a few months, this person's giving their notice in a few months, and suddenly I was alone on a team, which is a product team, but we own our data centers, and we spend a lot of time on infrastructure, we spend a lot of time on compliance, and really, we know, yeah, and we're sort of also struggling cos we're wanting to roll out to new regions, and spinning up a data center's really expensive. Nice, so, where did we look at going? So we sort of considered a few different options. This was whether we wanted to get HSMs hosted by external companies, so we did less of the work, or what came along was the Amazon Payment cryptography. We sort of sort of fit all our solutions, and we're heavily, we're a company which is already fully focused on fully managed infrastructure, so we're using ECS Fargate, for example, we're using elastic load balances. So for us, it seemed like the perfect solution that we can spin it up, zero work required, we just start sending requests. So, what did we plan? So the first thing, which was the very boring blocker, is before we could actually do any work, we had to get audit approval. So this was because we are doing PCI P2PE, which is for card reader terminals you ship out to the merchants. It reduces the audit scope if those terminals are under PTI P2PE. So, but before you can do that, that's looking at your current environment, so we ended up having to get a Delta audit done for that before we could even start deploying anything to production. We also found since it was a very new service, it was learning both within PayPal it's designed to sort of approve the service and with our auditors. The next step after we could roll that out was what we called shadowing, so this is where we wanted to mirror traffic to both setups so we could sort of see how payment cryptography performs before we sort of switch anything. I'll go into more detail in a second. Oh this was sort of, yeah, how we were going to do this was a gradual rollout, and this was again because we had a large amount of external dependencies when doing this project. So for example, within our cryptography setup, we have keys for the incoming terminals, we have keys for the outgoing acquirers, and in some cases we had to exchange new keys or we had to see that the acquirers would support any changes in our, yeah, in our encryption methods. So it sort of ended up being a little staggered bit by bit. And then promotion, so the end goal was that we get rid of our HSMs from our transaction flow and that we no longer think about them and I no longer have to think about audits or every quarter going through and checking the configurations haven't changed and sending my shares off to the off to the auditors. Right, so how did we sort of try and do the shadowing? So as with the previous flow, we sort of had a request coming into our payment gateway, and here we would either send them off to the HSM via our crypto interface, or we'd send them to payment cryptography. So our original plan was that we were going to keep our little crypto service as the abstraction layer between the HSMs and payment cryptography, but we quickly found we could just drop this entire service from the flow, because although it was sort of necessary when talking to these HSMs which have these binary wire protocols and you've got to deal with connection pooling. Now we were just calling it an AWS API. It was no different to doing an S3 put object or something or a Dynamo DB call. So we, we realized we could move that whole crypto work into our payment gateway service and sort of knock out an entire middleman. But for the shadowing, we would always send our request to the HSM and that is always the, the response we would use, and then asynchronously, we could spend it, we would send it off to payment cryptography and sort of record. The response and since a lot of these cryptography operations they are idempotent, you've always got the same result, we can actually sort of look at the binary response, so we can measure both the correctness and the response times with our full production traffic. Yeah, so It's a very noisy slide, but I sort of want to talk about. Um, how were we measuring this? So as I said before, we would send our, every time we made a request, we'd send it off to our metrics, and we could sort of, and then every morning I'd wake up and this would be my dashboard I'd look at. And you can sort of see that we have this result discrepancies, for example, which was showing, hey, were we getting a different response when doing this request against our HSM or against payment cryptography? And I think this case was a small bug in your, on your side, but we had that close relationship with AWS that we sort of said, hey, we're seeing this, and they could fix it, and but it's still, we could get the full confidence here without having to sort of have any transaction input. And I think a lot of what we're doing it was very similar to other learnings you do from where we're moving on-prem to cloud-based, so suddenly we had a lot less control over our latency. So here we can see the APC, the blue line, it sort of has this very peaky weather, yeah, peaky response time, so during the nights when we had lower traffic, we found it would increase, and I, I think that's cos there was some kind of sort of cold start time. But then this was when we sort of just had started doing this um, shadowing, so we'd just rolled it out, back in March, and then 6 months later. We could see for example the translate pin duration because we're sort of doing a lot more requests, that's dropped lower and we're sort of keeping a lot more on top of things. And then we also had this skipped operations, and this is what I was sort of mentioning that we couldn't just roll this out in one big bang, and we didn't want to. We wanted to sort of gradually roll out, get as much data going through this as possible without having to wait for everything. So here we had to skip some operations because it was supported by our HSM setup but not quite supported by our APC setup that was, yeah, lack of keys exchange or some other reason. But, and then after we'd sort of done this shadowing for, yeah, originally we were planning on doing it for sort of 3 to 6 months, I think, cos ultimately we had the data center contracts and we couldn't just switch over instantly as soon as we sort of wanted to do, we'd still be playing there, so we wanted to sort of keep it going in parallel for a long time, give us real confidence. But we found that didn't happen so much, because after, I think, 2 months of this shadowing, or 1 month of this shadowing, we were doing sort of routine patching in one of our data centers in London. And we had an issue. One of our switches came down and that took the other switch down. And suddenly we had to sort of, so we shifted traffic over to another data center for our HSMs, and then we sort of, for the first time, we could actually help with this from our office in Stockholm, as well as the people on the ground. The ones on the ground in the data center were trying to fix the switch, and here we were in Stockholm thinking, hey, maybe we can just skip this whole operation to the skip the whole traffic to the data center. And suddenly overnight, we just shifted everything to APC rather than to HSMs. And yeah, it's uh like I said, it's really nice that we could actually feel useful and achieve something, and since we've been doing that shadow for so long, we've had the confidence there. And yeah, everything suddenly no more HSMs, no more data involved, and zero customer impact, which was the real pleasure there, that we avoided an incident, even if we had that redundancy, we still. Had would have had reduced redundancy if we hadn't managed to swap over here. And I think that's something I didn't mention earlier is for our customers, we're really focused on this reliability. Since we have a lot of small, medium businesses, they sort of, they can't handle a day, a day of downtime. If they miss a day's a day's transactions selling their things at the Christmas market, there's a good chance they won't survive, so we're really focused on this, and it was the biggest importance to us that we just didn't, we didn't lose, start losing transactions. Right, and then the results. So, there were difficult parts. I think this is, as I was saying before, ultimately, although it's cryptography and I thought it was unique and special, I realized all we're doing is a very standard moving from on-prem to cloud. And it's work. You hit up all these old flows, you end up having to touch all parts of the code base, even bits which you're questioning, is this still used, but you have to touch them anyway. And it's, yeah, it, it's just work, I think it is just a classic. And it was a very new AWS service. I mean, it was both that we had teething issues, but in return we also had the close relationship with you, which was nice. But it was also new that within PayPal, I had to say, hey, we want to use this new service. Yes, I know it's cryptography in the cloud and you don't believe it exists, but it does. And yeah, and it's the same with our auditors, they had, I think we ended up sending them to you to sort of have a meeting and figure out a little bit more about how AWS payment cryptography works. And then, yeah, so as much as I'd like to say that we have no HSMs anymore. We do still have some long tail flows, which we're working from two ways, both how we do things and getting help on new features on the AWS side to get rid of those. But we are 99.9, maybe 1.9% of traffic, so not, not going through our HSM. But for now we have kept one and we're gonna keep one in our secure room for handling incoming key components. But the fact that this is no longer on my plate is just such a relief, this is. That it was my own thing to own before. Wins, this is what I enjoy. PTI compliance. So I, I spend a lot of my time thinking about PTI compliance. I'm sort of very heavily involved in the yearly audits for P2P for DSS, then you've got every 2 years your PTI P2PE, and then every 3 years for PIN. And a huge amount of those audits, yeah, has. That, as I said, that, that's sort of it, it's a non-negotiable, we had to sort of keep that compliance, and this is definitely what when talking to PayPal, they didn't believe this service was actually going to be capable of doing, whether it was going to be PCIPI compliant. This one I, I, I've struggled with sort of how to, how to phrase this, that. When we've moved from the HSM, so we're, yeah, they sort of have very old fashioned interfaces, they've got very precise interfaces, they're clearly made, hey, this product, this payment feature needed this this exact command to use that, and now we've moved to payment cryptography, and suddenly it's instead of sending a, a translate PIN command which corresponds to a couple of digits, followed by exclamation mark and then a code block, we're now using a JSON API which is called Translate PIN. And suddenly we found that we are designing our features not around what our HSMs can support. We don't talk to our third parties and say, hey, you want to do this, or we can't do that, we need to check with HSM. We, I just took it for granted that we have the features in payment cryptography, that it is generic, you can do from one type of key to another type of key. And increased resilience, because ultimately, I was never one, a person who should have been in charge of switches in a data center, but I was, and moving it to AWS has sort of got it up to the same standard that all of our other services are, and it's just a load off our mind. And yeah, the really important thing here is launching a new region. So, as I said, we were in the 3 regions. There was just one in the US and a couple in Europe, but now that we're expanding more in the US and we're sort of becoming a greater part of the PayPal offering, we want to spin up another one in the, in the US, and previously that was 10 tens of thousands of dollars. So we'd have to rent the rack, get the fiber lines set up, buy hardware, buy licenses for that hardware. And now, when we're moving into a new region, payment cryptography is the only bit which doesn't cost more money. We might have to spend more money on compute and having that spinning up, and load balances, and network and storage, but APC now, it's a per request model, we are just shifting traffic from one region to another, so it is genuinely free to launch a new region, so it's really nice that my team has gone from the blocker to the enabler. More wins, developer ownership, this is for me the biggest win, and I think the most unexpected one. Is although we're a bigger product team and we have sort of very high vertical ownership, within that team, there has always been some crypto people, and it's been our responsibility to sort of always, anytime we needed to do changes to our abstraction layer, it was on, it was on us to do, because other people are terrified of crypto. It isn't something which they feel they can touch, they don't want to understand it, and the H70 we had, the interface was sort of complex enough that it didn't feel like you could understand it. But now, as I said, it's just like calling S3, it is just like calling Dynamo DB, it is a AWS API, it is in the crypto code, developers are touching it, developers are thinking about the performance of it, they're thinking about, hey, do I need to do more connection porting, because it's something they're familiar with, it is no longer a big unknown. Um, product focus, as I said, we were a small team and we had data centers. We had 3 data centers around the world, we would have to fly around to them to do patching, and sometimes do patching badly, clearly, but. We owned a lot of infrastructure and we spent a lot of time, and now we can actually, my job is transformed. Since I started 2 years ago in PayPal, my job has transformed from being infrastructure focused. To being product focused And reduced audio scope, so this is sort of ties in a little bit to the last that more product focused that. Every single time we had our on-site audit, we would have to go through all of our configurations. We would have to get those signed off, what commands we have enabled, and now this is almost entirely shifted over to you guys that we are now. Just the user of it And yeah, I think that was all for me. Yeah, there you go. Uh thank you so much, Philip, for, for sharing that. Uh, so just a quick summary of, uh, kind of what we just talked about today. So, uh, thank you for sharing about PayPal's experience, uh, getting rid of, uh, or almost getting rid of one of your last dependencies on your physical data centers. Uh, I think it was great that you were able to maintain your PCI PIN and, and P2PE the entire time. Um, you got, uh, I think you, you gave a good example there of going into a new region that effectively it costs you no money. You can easily go into new regions. Uh, I think we're in 12 regions today and, and more in the future, simplified infrastructure, you know, you mentioned actually getting rid of hundreds of lines of code, um, and getting rid of your middleware. Your developers can just directly use this because it's a restful API, um, and, uh, you know, definitely thank you, great partnership, um. You know, I think you've been alive on the service now, uh, about a little bit over a year or something like that, um, so obviously I think as you saw in those before and after graphs, not only, uh, was PayPal happy with the performance when they originally joined the performance and stability, we've actually increased those, um, those capabilities since we joined. So, uh, definitely thank you to Philip for coming here and sharing PayPal's story. Uh, thank you, uh, to the audience today, and, uh, if anyone has any questions or wants to talk a little bit about their experience or has questions, uh, Philip and myself will be outside after the presentation. So, uh, thank you very much, everybody. Thank you very much.